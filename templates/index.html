<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mamoliti Solutions - Gesti√≥n de Precios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #scanner {
            position: relative;
            width: 100%;
            height: 280px;
            overflow: hidden;
            border-radius: 12px;
        }

        #scanner video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index:1;
        }

        #overlay-rect {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 90%;
            height: 40%;
            transform: translate(-50%, -50%);
            border: 3px solid red;
            box-sizing: border-box;
            pointer-events: none;
            z-index:2;
            border-radius: 8px;
            box-shadow: 0 0 0 2000px rgba(0,0,0,0.4);
            transition: border-color 0.1s ease;
        }

        #scannerStatus {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f8f9fa; }
        .btn { border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #4f46e5; color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; }
        .btn-primary:hover { background: #4338ca; }
        .btn-success { background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; }
        .btn-danger { background: #ef4444; color: white; padding: 12px 24px; border-radius: 8px; }
        .btn-warning { background: #f59e0b; color: white; padding: 12px 24px; border-radius: 8px; }
        .input-field { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; }
        .input-field:focus { outline: none; border-color: #4f46e5; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-5">
    
    <!-- Main App -->
    <div id="appScreen" class="max-w-4xl mx-auto space-y-4">
        
        <!-- Header -->
        <div class="card flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
            <div>
                <h1 style="font-size: 24px; font-weight: 700; color: #111827;">üì¶ Sistema de Precios</h1>
                <p id="tokenStatus" style="color: #6b7280; margin-top: 4px; font-size: 13px;"></p>
            </div>
            <button id="configBtn" class="btn btn-warning w-full sm:w-auto">üñ®Ô∏è Impresora</button>
        </div>

        <!-- Scanner Section -->
        <div class="card space-y-3">
            <button id="cameraBtn" class="btn btn-primary w-full">üì∑ Escanear</button>
            
            <div id="cameraContainer" class="hidden">
                <div class="relative bg-black rounded-lg overflow-hidden">
                    <div id="scanner">
                        <div id="overlay-rect"></div>
                        <div id="scannerStatus">üî¥ Enfoca el c√≥digo</div>
                    </div>
                    <button id="stopCameraBtn" style="position: absolute; top: 10px; right: 10px; z-index: 10;" class="btn btn-danger" style="padding: 10px 14px;">‚úï</button>
                </div>
            </div>

            <div style="border-top: 2px solid #e5e7eb; padding-top: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px; font-size: 13px;">O escribe manualmente:</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="manualCode" placeholder="C√≥digo de barras" class="input-field" style="flex: 1; font-size: 14px;">
                    <button id="searchBtn" class="btn btn-success" style="white-space: nowrap;">üîç</button>
                </div>
            </div>
        </div>

        <!-- Product Details -->
        <div id="productSection" class="hidden card space-y-3">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="productTitle" style="font-size: 20px; font-weight: 700;"></h2>
                <button id="backBtn" class="btn btn-primary" style="padding: 10px 16px;">‚Üê Volver</button>
            </div>

            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px; border-radius: 8px; text-align: center;">
                <p style="font-size: 11px; margin-bottom: 4px;">C√ìDIGO</p>
                <p id="barcodeDisplay" style="font-size: 20px; font-weight: 700; letter-spacing: 1px;"></p>
            </div>

            <div id="notFoundAlert" class="hidden" style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 6px;">
                <p style="font-weight: 700; margin-bottom: 8px; font-size: 14px;">‚ö†Ô∏è Producto no encontrado</p>
                <button id="addProductBtn" class="btn btn-primary w-full">‚ûï Agregar</button>
            </div>

            <div class="space-y-2">
                <div>
                    <label style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 13px;">Nombre *</label>
                    <input type="text" id="name" class="input-field" disabled style="font-size: 14px;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                    <div>
                        <label style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 12px;">Compra</label>
                        <input type="number" id="pricebuy" step="0.01" class="input-field" disabled style="font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 12px;">Margen %</label>
                        <input type="number" id="margen" step="0.1" class="input-field" disabled style="font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; display: block; margin-bottom: 4px; font-size: 12px;">Venta *</label>
                        <input type="number" id="pricesell" step="0.01" class="input-field" disabled style="font-size: 13px;">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                <button id="editBtn" class="btn btn-primary w-full" style="padding: 10px;">‚úèÔ∏è Editar</button>
                <button id="saveBtn" class="hidden btn btn-success w-full" style="padding: 10px;">üíæ Guardar</button>
                <button id="printBtn" class="hidden btn btn-success w-full" style="padding: 10px;">üñ®Ô∏è Imprimir</button>
                <button id="deleteBtn" class="hidden btn btn-danger w-full" style="padding: 10px;">üóëÔ∏è Eliminar</button>
            </div>
        </div>

        <!-- Products List -->
        <div class="card">
            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">
                Productos (<span id="productCount">0</span>)
            </h3>
            <div id="productsContainer" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n de Impresora -->
    <div id="printerModal" class="modal">
        <div class="modal-content">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">üñ®Ô∏è Configurar Impresora</h2>
            
            <div id="printerStatus" style="padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <p style="font-weight: 600; font-size: 14px;">Estado: <span id="statusText">Sin configurar</span></p>
                <p id="printerName" style="color: #6b7280; font-size: 13px; margin-top: 4px;"></p>
            </div>

            <div style="margin-bottom: 16px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">M√©todo</label>
                <select id="printMethod" class="input-field" style="font-size: 14px;">
                    <option value="local">üñ•Ô∏è Servidor Local</option>
                    <option value="image">üñºÔ∏è Generar PNG</option>
                    <option value="system">üñ®Ô∏è Sistema</option>
                </select>
            </div>

            <div id="methodInfo" style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 12px; line-height: 1.6;"></div>

            <div id="localServerConfig">
                <div style="margin-bottom: 12px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">URL del Servidor</label>
                    <input type="text" id="serverUrl" value="http://localhost:8080" class="input-field" style="font-size: 13px;">
                </div>

                <button id="testServerBtn" class="btn btn-primary w-full" style="margin-bottom: 8px; padding: 10px;">üîå Probar</button>
                <button id="loadPrintersBtn" class="btn btn-primary w-full" style="margin-bottom: 12px; padding: 10px;">üìã Cargar</button>

                <div id="printersListContainer" class="hidden" style="margin-bottom: 12px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">Impresora</label>
                    <select id="printersList" class="input-field" style="font-size: 14px;">
                        <option value="">-- Seleccione --</option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">Ancho (mm)</label>
                <input type="number" id="labelWidth" value="58" class="input-field" style="font-size: 13px;">
            </div>

            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">Copias</label>
                <input type="number" id="labelCopies" value="1" min="1" max="10" class="input-field" style="font-size: 13px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <button id="testPrintBtn" class="btn btn-success w-full" style="padding: 10px;">üß™ Prueba</button>
                <button id="saveConfigBtn" class="btn btn-primary w-full" style="padding: 10px;">üíæ Guardar</button>
            </div>
            
            <button id="closeModalBtn" class="btn btn-danger w-full" style="padding: 10px;">‚úï Cerrar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
        let globalToken = null;

        function initializeEventListeners() {
            document.getElementById('configBtn').addEventListener('click', () => PrinterConfig.openModal());
            document.getElementById('cameraBtn').addEventListener('click', () => App.startCamera());
            document.getElementById('stopCameraBtn').addEventListener('click', () => App.stopCamera());
            document.getElementById('searchBtn').addEventListener('click', () => App.searchProduct());
            document.getElementById('backBtn').addEventListener('click', () => App.closeProduct());
            document.getElementById('editBtn').addEventListener('click', () => App.enableEditing());
            document.getElementById('saveBtn').addEventListener('click', () => App.saveProduct());
            document.getElementById('printBtn').addEventListener('click', () => Printer.print());
            document.getElementById('deleteBtn').addEventListener('click', () => App.deleteProduct());
            document.getElementById('addProductBtn').addEventListener('click', () => App.enableEditing());
            
            document.getElementById('printMethod').addEventListener('change', () => PrinterConfig.updateMethodInfo());
            document.getElementById('testServerBtn').addEventListener('click', () => PrinterConfig.testServerConnection());
            document.getElementById('loadPrintersBtn').addEventListener('click', () => PrinterConfig.loadPrinters());
            document.getElementById('saveConfigBtn').addEventListener('click', () => PrinterConfig.saveConfig());
            document.getElementById('testPrintBtn').addEventListener('click', () => PrinterConfig.testPrint());
            document.getElementById('closeModalBtn').addEventListener('click', () => PrinterConfig.closeModal());
            
            document.getElementById('manualCode').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') App.searchProduct();
            });
            
            document.getElementById('pricebuy').addEventListener('input', () => App.recalculatePrice());
            document.getElementById('margen').addEventListener('input', () => App.recalculatePrice());
            document.getElementById('pricesell').addEventListener('input', () => App.onPriceSellChange());
        }

        function initializeToken() {
            const params = new URLSearchParams(window.location.search);
            const tokenFromUrl = params.get("token");

            if (tokenFromUrl) {
                globalToken = tokenFromUrl;
                try {
                    localStorage.setItem("auth_token", tokenFromUrl);
                } catch(e) {
                    console.log("‚ö†Ô∏è localStorage no disponible");
                }
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (!globalToken) {
                globalToken = localStorage.getItem("auth_token");
            }
            
            const tokenStatus = document.getElementById('tokenStatus');
            if (globalToken) {
                const shortToken = globalToken.substring(0, 16) + '...';
                tokenStatus.textContent = `‚úÖ Activo (${shortToken})`;
                tokenStatus.style.color = '#10b981';
            } else {
                tokenStatus.textContent = '‚ö†Ô∏è Sin token';
                tokenStatus.style.color = '#ef4444';
            }
        }

        function getAuthHeaders(extra = {}) {
            return { ...extra, "Authorization": `Bearer ${globalToken || ''}` };
        }

        const PrinterConfig = {
            init() {
                const saved = localStorage.getItem('printer_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    this.updateStatus(`‚úÖ ${config.method}`, config.printerName || '');
                    App.updatePrintButton(true);
                }
                this.updateMethodInfo();
            },

            openModal() {
                document.getElementById('printerModal').classList.add('active');
            },

            closeModal() {
                document.getElementById('printerModal').classList.remove('active');
            },

            updateStatus(status, name = '') {
                document.getElementById('statusText').textContent = status;
                document.getElementById('printerName').textContent = name;
                
                const statusDiv = document.getElementById('printerStatus');
                statusDiv.style.background = status.includes('‚úÖ') ? '#d1fae5' : '#f3f4f6';
            },

            updateMethodInfo() {
                const method = document.getElementById('printMethod').value;
                const info = document.getElementById('methodInfo');
                const localConfig = document.getElementById('localServerConfig');
                
                localConfig.style.display = method === 'local' ? 'block' : 'none';
                
                const infos = {
                    local: '‚úÖ Funciona sin HTTPS | ‚úÖ Impresi√≥n directa | ‚ö†Ô∏è Requiere servidor',
                    image: '‚úÖ Cualquier dispositivo | ‚úÖ Sin servidor | ‚ö†Ô∏è Descarga manual',
                    system: '‚úÖ Impresora por defecto | ‚ö†Ô∏è Solo servidor local | ‚ö†Ô∏è Permisos requeridos'
                };
                
                info.innerHTML = infos[method];
            },

            async testServerConnection() {
                const serverUrl = document.getElementById('serverUrl').value.trim();
                try {
                    const response = await fetch(`${serverUrl}/health`);
                    const data = await response.json();
                    this.updateStatus('‚úÖ Conectado', `${data.platform}`);
                    alert('‚úÖ Conexi√≥n exitosa');
                } catch (error) {
                    this.updateStatus('‚ùå Error', '');
                    alert(`‚ùå Error: ${error.message}`);
                }
            },

            async loadPrinters() {
                const serverUrl = document.getElementById('serverUrl').value.trim();
                try {
                    const response = await fetch(`${serverUrl}/printers`);
                    const data = await response.json();
                    
                    if (data.success && data.printers.length > 0) {
                        const select = document.getElementById('printersList');
                        select.innerHTML = '<option value="">-- Seleccione --</option>';
                        data.printers.forEach(printer => {
                            const option = document.createElement('option');
                            option.value = printer;
                            option.textContent = printer;
                            select.appendChild(option);
                        });
                        document.getElementById('printersListContainer').classList.remove('hidden');
                        alert(`‚úÖ ${data.printers.length} impresora(s) encontrada(s)`);
                    }
                } catch (error) {
                    alert(`‚ùå Error: ${error.message}`);
                }
            },

            saveConfig() {
                const method = document.getElementById('printMethod').value;
                const config = {
                    method,
                    width: parseInt(document.getElementById('labelWidth').value),
                    copies: parseInt(document.getElementById('labelCopies').value),
                    serverUrl: document.getElementById('serverUrl').value.trim(),
                    printerName: document.getElementById('printersList').value
                };
                
                localStorage.setItem('printer_config', JSON.stringify(config));
                this.updateStatus(`‚úÖ ${method}`, config.printerName || method);
                App.updatePrintButton(true);
                alert('‚úÖ Guardado');
            },

            async testPrint() {
                const testData = { name: 'Test', code: '1234567890128', price: 100 };
                await Printer.print(testData);
            }
        };

        const Printer = {
            async print(productData = null) {
                const config = localStorage.getItem('printer_config');
                if (!config) {
                    alert('‚ö†Ô∏è Configura una impresora primero');
                    return;
                }

                const printerConfig = JSON.parse(config);
                
                if (!productData) {
                    productData = {
                        name: document.getElementById('name').value,
                        code: document.getElementById('barcodeDisplay').textContent,
                        price: parseFloat(document.getElementById('pricesell').value)
                    };
                }

                try {
                    const serverUrl = printerConfig.serverUrl || 'http://localhost:8080';
                    const response = await fetch(`${serverUrl}/print`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: productData.name,
                            code: productData.code,
                            price: productData.price,
                            printer: printerConfig.printerName,
                            copies: printerConfig.copies
                        })
                    });
                    
                    const result = await response.json();
                    alert(result.success ? '‚úÖ ' + result.message : '‚ùå ' + result.error);
                } catch (error) {
                    alert('‚ùå Error: ' + error.message);
                }
            }
        };

        const App = {
            state: { currentCode: null, isEditing: false, productExists: false },
            scanner: {
                ultimoCodigo: null,
                contador: 0,
                estado: "rojo",
                tiempoUltimaCambio: 0
            },

            init() {
                initializeToken();
                PrinterConfig.init();
                initializeEventListeners();
                
                if (!globalToken) {
                    document.getElementById('productsContainer').innerHTML = 
                        '<p style="text-align: center; color: #ef4444; padding: 20px;">‚ùå Token no v√°lido</p>';
                    return;
                }
                
                this.loadProductsList();
            },

            updatePrintButton(show) {
                const printBtn = document.getElementById('printBtn');
                printBtn.classList.toggle('hidden', !(show && this.state.productExists));
            },

            startCamera() {
                if (!globalToken) { alert('‚ùå No hay token'); return; }
                
                document.getElementById('cameraContainer').classList.remove('hidden');
                this.scanner = { ultimoCodigo: null, contador: 0, estado: "rojo", tiempoUltimaCambio: 0 };
                
                Quagga.init({
                    inputStream: {
                        type: "LiveStream",
                        target: document.querySelector('#scanner'),
                        constraints: {
                            facingMode: "environment",
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    frequency: 10,
                    decoder: {
                        readers: ["ean_reader"],
                        debug: { showCanvas: false }
                    }
                }, (err) => {
                    if (err) {
                        alert("‚ùå Error: " + err.message);
                        return;
                    }
                    Quagga.start();
                });

                Quagga.onDetected((result) => this.procesarCodigo(result));
            },

            procesarCodigo(result) {
                const codigo = result.codeResult.code;
                if (!codigo) return;

                const ahora = Date.now();
                
                // C√≥digo diferente
                if (codigo !== this.scanner.ultimoCodigo) {
                    this.scanner.ultimoCodigo = codigo;
                    this.scanner.contador = 1;
                    this.scanner.estado = "rojo";
                    this.scanner.tiempoUltimaCambio = ahora;
                    this.actualizarUI();
                    return;
                }

                // Mismo c√≥digo
                this.scanner.contador++;

                // Validaci√≥n EAN13 a partir de 2 detecciones
                if (this.scanner.contador >= 2 && !this.esEAN13Valido(codigo)) {
                    this.scanner.ultimoCodigo = null;
                    this.scanner.contador = 0;
                    this.scanner.estado = "rojo";
                    this.actualizarUI();
                    return;
                }

                // Cambiar estados: rojo (1) ‚Üí amarillo (2-3) ‚Üí verde (4+)
                if (this.scanner.contador >= 4) {
                    this.scanner.estado = "verde";
                } else if (this.scanner.contador >= 2) {
                    this.scanner.estado = "amarillo";
                }

                this.actualizarUI();

                // Confirmar a los 4 detectos (muy r√°pido)
                if (this.scanner.estado === "verde") {
                    Quagga.stop();
                    document.getElementById('cameraContainer').classList.add('hidden');
                    document.getElementById('manualCode').value = codigo;
                    this.searchProduct(codigo);
                }
            },

            stopCamera() {
                Quagga.stop();
                document.getElementById('cameraContainer').classList.add('hidden');
            },

            esEAN13Valido(codigo) {
                if (codigo.length !== 13 || isNaN(codigo)) return false;
                
                let suma = 0;
                for (let i = 0; i < 12; i++) {
                    suma += parseInt(codigo[i]) * (i % 2 === 0 ? 1 : 3);
                }
                const proximo = (10 - (suma % 10)) % 10;
                return proximo === parseInt(codigo[12]);
            },

            actualizarUI() {
                const rect = document.getElementById('overlay-rect');
                const status = document.getElementById('scannerStatus');
                const colores = { rojo: '#ef4444', amarillo: '#f59e0b', verde: '#10b981' };
                const textos = { 
                    rojo: 'üî¥ Enfoca el c√≥digo', 
                    amarillo: 'üü° Detectado (confirma)', 
                    verde: '‚úÖ ¬°C√≥digo v√°lido!' 
                };
                
                rect.style.borderColor = colores[this.scanner.estado];
                status.innerHTML = textos[this.scanner.estado];
                status.style.background = colores[this.scanner.estado] + 'cc';
            },

            async searchProduct(code = null) {
                if (!globalToken) { alert('‚ùå No hay token'); return; }
                if (!code) code = document.getElementById('manualCode').value.trim();
                if (!code) return alert('‚ö†Ô∏è Ingresa un c√≥digo');

                this.state.currentCode = code;

                try {
                    const response = await fetch(`/api/producto/${code}`, {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });

                    if (response.status === 401) {
                        alert('‚ùå Token inv√°lido');
                        localStorage.removeItem("auth_token");
                        globalToken = null;
                        window.location.reload();
                        return;
                    }

                    const data = await response.json();
                    this.displayProduct(data, code);
                } catch (error) {
                    alert('‚ùå Error: ' + error.message);
                }
            },

            displayProduct(data, code) {
                document.getElementById('productSection').classList.remove('hidden');
                document.getElementById('barcodeDisplay').textContent = code;

                if (data && data.encontrado && data.producto) {
                    this.state.productExists = true;
                    document.getElementById('notFoundAlert').classList.add('hidden');
                    document.getElementById('productTitle').textContent = data.producto.name;
                    document.getElementById('name').value = data.producto.name;
                    document.getElementById('pricebuy').value = data.producto.pricebuy;
                    document.getElementById('pricesell').value = data.producto.pricesell;
                    document.getElementById('margen').value = '';
                    document.getElementById('editBtn').classList.remove('hidden');
                    document.getElementById('deleteBtn').classList.remove('hidden');
                    this.updatePrintButton(true);
                    this.disableEditing();
                } else {
                    this.state.productExists = false;
                    document.getElementById('notFoundAlert').classList.remove('hidden');
                    document.getElementById('productTitle').textContent = 'Producto Nuevo';
                    document.getElementById('name').value = '';
                    document.getElementById('pricebuy').value = 0;
                    document.getElementById('pricesell').value = 0;
                    document.getElementById('margen').value = '';
                    document.getElementById('editBtn').classList.remove('hidden');
                    document.getElementById('deleteBtn').classList.add('hidden');
                    this.updatePrintButton(false);
                    this.disableEditing();
                }
            },

            enableEditing() {
                this.state.isEditing = true;
                ['name', 'pricebuy', 'margen', 'pricesell'].forEach(id => {
                    document.getElementById(id).disabled = false;
                });
                document.getElementById('editBtn').classList.add('hidden');
                document.getElementById('saveBtn').classList.remove('hidden');
            },

            disableEditing() {
                this.state.isEditing = false;
                ['name', 'pricebuy', 'margen', 'pricesell'].forEach(id => {
                    document.getElementById(id).disabled = true;
                });
                document.getElementById('editBtn').classList.remove('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
            },

            recalculatePrice() {
                const buy = parseFloat(document.getElementById('pricebuy').value) || 0;
                const margin = parseFloat(document.getElementById('margen').value) || 0;
                
                if (buy > 0 && margin > 0) {
                    document.getElementById('pricesell').value = (buy * (1 + margin / 100)).toFixed(2);
                }
            },

            onPriceSellChange() {
                const buy = parseFloat(document.getElementById('pricebuy').value) || 0;
                const sell = parseFloat(document.getElementById('pricesell').value) || 0;
                
                if (buy > 0 && sell > 0) {
                    const calculatedMargin = ((sell - buy) / buy * 100).toFixed(1);
                    document.getElementById('margen').value = calculatedMargin;
                }
            },

            async saveProduct() {
                const name = document.getElementById('name').value.trim();
                if (!name) return alert('‚ö†Ô∏è El nombre es obligatorio');

                const producto = {
                    code: this.state.currentCode,
                    reference: this.state.currentCode,
                    name: name,
                    pricebuy: parseFloat(document.getElementById('pricebuy').value) || 0,
                    pricesell: parseFloat(document.getElementById('pricesell').value) || 0,
                    margen: parseFloat(document.getElementById('margen').value) || 0
                };

                try {
                    const response = await fetch('/api/producto', {
                        method: 'POST',
                        headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
                        body: JSON.stringify(producto)
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Producto guardado');
                        this.disableEditing();
                        this.loadProductsList();
                        this.searchProduct(this.state.currentCode);
                    } else {
                        alert('‚ùå Error: ' + data.error);
                    }
                } catch (error) {
                    alert('‚ùå Error de conexi√≥n');
                }
            },

            async deleteProduct() {
                if (!confirm('‚ö†Ô∏è ¬øEliminar este producto?')) return;

                try {
                    const response = await fetch(`/api/producto/${this.state.currentCode}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('‚úÖ Producto eliminado');
                        this.closeProduct();
                        this.loadProductsList();
                    }
                } catch (error) {
                    alert('‚ùå Error');
                }
            },

            closeProduct() {
                document.getElementById('productSection').classList.add('hidden');
                document.getElementById('manualCode').value = '';
                this.state.currentCode = null;
            },
            
            async loadProductsList() {
                if (!globalToken) return;

                try {
                    const response = await fetch('/api/productos', {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });

                    if (response.status === 401) {
                        alert('‚ùå Token inv√°lido');
                        localStorage.removeItem("auth_token");
                        globalToken = null;
                        window.location.reload();
                        return;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        document.getElementById('productsContainer').innerHTML =
                            `<p style="color:#ef4444;padding:20px;">‚ö†Ô∏è Error: ${errorData.error}</p>`;
                        return;
                    }

                    const data = await response.json();
                    const productos = data.productos || [];

                    document.getElementById('productCount').textContent = productos.length;

                    const container = document.getElementById('productsContainer');

                    if (productos.length === 0) {
                        container.innerHTML =
                            '<p style="text-align:center;color:#9ca3af;padding:20px;">üì¶ No hay productos</p>';
                        return;
                    }

                    container.innerHTML = productos.map(p => `
                        <div onclick="App.searchProduct('${p.code}')"
                            style="background:white;border:2px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <p style="font-weight:700;font-size:14px;">${p.name}</p>
                                    <p style="color:#6b7280;font-size:12px;margin-top:4px;">${p.code}</p>
                                </div>
                                <p style="font-size:18px;font-weight:700;color:#10b981;">
                                    ${Number(p.pricesell).toFixed(2)}
                                </p>
                            </div>
                        </div>
                    `).join('');

                } catch (error) {
                    document.getElementById('productsContainer').innerHTML =
                        `<p style="color:#ef4444;padding:20px;">‚ùå Error: ${error.message}</p>`;
                }
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => App.init());
        } else {
            App.init();
        }
    </script>
</body>
</html>